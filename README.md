# Amazon Kenya â€” Backend API

A full-featured Django REST Framework e-commerce backend for a Kenyan phone & electronics store, with M-Pesa Daraja STK Push integration, JWT authentication, cart management, wishlists, and order tracking.

---

## Table of Contents

- [Project Structure](#project-structure)
- [Tech Stack](#tech-stack)
- [Prerequisites](#prerequisites)
- [Getting Started](#getting-started)
- [Environment Variables](#environment-variables)
- [API Reference](#api-reference)
- [M-Pesa Integration](#m-pesa-integration)
- [Running in Production](#running-in-production)
- [Troubleshooting](#troubleshooting)

---

## Project Structure

```
Amazon_Kenya/
â”œâ”€â”€ backend/                        # Django project root
â”‚   â”œâ”€â”€ backend/                    # Project configuration package
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ settings.py             # All settings (DB, JWT, M-Pesa, CORS, email)
â”‚   â”‚   â”œâ”€â”€ urls.py                 # Root URL configuration
â”‚   â”‚   â””â”€â”€ wsgi.py                 # WSGI entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ store/                      # Main application
â”‚   â”‚   â”œâ”€â”€ migrations/             # Django database migrations
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ admin.py                # Django admin registrations
â”‚   â”‚   â”œâ”€â”€ models.py               # All data models (see Models section)
â”‚   â”‚   â”œâ”€â”€ serializers.py          # DRF serializers
â”‚   â”‚   â”œâ”€â”€ views.py                # ViewSets and API views
â”‚   â”‚   â”œâ”€â”€ urls.py                 # App-level URL patterns
â”‚   â”‚   â””â”€â”€ filters.py              # (optional) Custom django-filter classes
â”‚   â”‚
â”‚   â”œâ”€â”€ media/                      # User-uploaded files (gitignored)
â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”œâ”€â”€ categories/
â”‚   â”‚   â”œâ”€â”€ brands/
â”‚   â”‚   â”œâ”€â”€ banners/
â”‚   â”‚   â””â”€â”€ avatars/
â”‚   â”‚
â”‚   â”œâ”€â”€ static/                     # Static assets
â”‚   â”œâ”€â”€ staticfiles/                # Collected static (generated by collectstatic)
â”‚   â”œâ”€â”€ logs/                       # Log files (gitignored)
â”‚   â”‚   â””â”€â”€ django.log
â”‚   â”‚
â”‚   â”œâ”€â”€ .env                        # Environment variables (gitignored â€” see below)
â”‚   â”œâ”€â”€ .env.example                # Safe template to commit
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ db.sqlite3                  # SQLite dev database (gitignored in prod)
â”‚   â”œâ”€â”€ manage.py
â”‚   â””â”€â”€ requirements.txt
â”‚
â””â”€â”€ README.md                       # This file
```

---

## Tech Stack

| Layer | Technology |
|---|---|
| Framework | Django 5.x + Django REST Framework |
| Auth | Simple JWT (`rest_framework_simplejwt`) |
| Filtering | `django-filter` |
| CORS | `django-cors-headers` |
| Payments | Safaricom Daraja API (M-Pesa STK Push) |
| Database | SQLite (dev) â†’ PostgreSQL (prod) |
| Media Storage | Local filesystem / S3 (prod) |
| HTTP Client | `requests` |
| Env Loading | `python-dotenv` |

---

## Prerequisites

- Python 3.10+
- pip
- A [Safaricom Daraja](https://developer.safaricom.co.ke) account (sandbox is free)
- [ngrok](https://ngrok.com) for local M-Pesa callback testing

---

## Getting Started

### 1. Clone and create a virtual environment

```bash
git clone https://github.com/youruser/Amazon-kenya.git
cd Amazon-kenya/backend
python -m venv venv

# Windows
venv\Scripts\activate

# macOS / Linux
source venv/bin/activate
```

### 2. Install dependencies

```bash
pip install -r requirements.txt
```

`requirements.txt` should include:

```
django>=5.0
djangorestframework
djangorestframework-simplejwt
django-cors-headers
django-filter
requests
Pillow
python-dotenv
```

### 3. Configure environment variables

```bash
cp .env.example .env
# Then fill in your real values â€” see Environment Variables section below
```

### 4. Apply migrations and create a superuser

```bash
python manage.py migrate
python manage.py createsuperuser
```

### 5. Create required directories

```bash
mkdir -p logs media/products media/categories media/brands media/banners media/avatars
```

### 6. Run the development server

```bash
python manage.py runserver
```

API is now available at `http://127.0.0.1:8000/api/v1/`

Admin panel: `http://127.0.0.1:8000/admin/`

---

## Environment Variables

Copy `.env.example` to `.env` and fill in your values. The file is loaded automatically via `load_dotenv()` at the top of `settings.py`.

```dotenv
# â”€â”€ Django â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SECRET_KEY=your-django-secret-key-here
DEBUG=True
FRONTEND_URL=http://localhost:5173

# â”€â”€ M-Pesa Daraja API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Credentials from https://developer.safaricom.co.ke â†’ Your App â†’ Keys
MPESA_CONSUMER_KEY=your_consumer_key
MPESA_CONSUMER_SECRET=your_consumer_secret

# Sandbox shortcode â€” use your actual PayBill/Till for production
MPESA_SHORTCODE=174379

# LNM Passkey from Daraja portal (under your app's Lipa na M-Pesa settings)
MPESA_PASSKEY=bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919

# Must be HTTPS. For local dev run: ngrok http 8000
# IMPORTANT: path must match your urls.py exactly
MPESA_CALLBACK_URL=https://xxxx.ngrok-free.app/api/v1/mpesa/callback/

# â”€â”€ Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=you@gmail.com
EMAIL_HOST_PASSWORD=your_app_password   # Gmail App Password (16 chars, no spaces)
DEFAULT_FROM_EMAIL="Amazon Kenya <you@gmail.com>"
```

**Important:** `settings.py` must have these two lines at the very top (before any `os.environ.get()` calls):

```python
from dotenv import load_dotenv
load_dotenv(BASE_DIR / '.env')
```

---

## Data Models

| Model | Purpose |
|---|---|
| `Category` | Hierarchical product categories (parent/subcategory) |
| `Brand` | Product brands with logo and featured flag |
| `Product` | Core product with UUID PK, slugs, flags (featured/hot/new) |
| `ProductVariant` | SKU-level variants: color, storage, RAM, price, stock |
| `ProductImage` | Multiple images per product with primary flag |
| `ProductSpecification` | Key-value spec rows per product |
| `Review` | User reviews with rating (1â€“5), verified purchase flag |
| `Banner` | Hero/promo/section banners for homepage |
| `Cart` | Session or user-linked shopping cart |
| `CartItem` | Line items linked to cart + product + variant |
| `Order` | Completed order with shipping, payment status, M-Pesa fields |
| `OrderItem` | Snapshot of product/variant at time of purchase |
| `MpesaTransaction` | STK push audit log per checkout request |
| `RecentlyViewed` | Per-user or per-session product view history |
| `Wishlist` | User's saved products |
| `UserProfile` | Extended profile: phone, avatar, address |

---

## API Reference

Base URL: `/api/v1/`

### Authentication

| Method | Endpoint | Description |
|---|---|---|
| `POST` | `/auth/register/` | Register new user, returns JWT tokens |
| `POST` | `/auth/login/` | Login with email or username, returns JWT tokens |
| `POST` | `/auth/token/refresh/` | Refresh access token |
| `GET` | `/auth/profile/` | Get current user profile (ðŸ”’) |
| `PATCH` | `/auth/profile/` | Update profile fields (ðŸ”’) |

**Login request:**
```json
{ "email": "user@example.com", "password": "yourpassword" }
```

**Token usage:**
```
Authorization: Bearer <access_token>
```

---

### Categories

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/categories/` | Top-level categories with subcategories nested |
| `GET` | `/categories/{slug}/` | Single category detail |
| `GET` | `/categories/all_flat/` | All categories flat (including subcategories) |

---

### Brands

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/brands/` | All active brands |
| `GET` | `/brands/{slug}/` | Single brand |
| `GET` | `/brands/featured/` | Featured brands only |

---

### Products

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/products/` | Paginated product list |
| `GET` | `/products/{slug}/` | Full product detail (tracks recently viewed) |
| `GET` | `/products/{slug}/related/` | Products in same category |
| `GET` | `/products/featured/` | Featured products (max 10) |
| `GET` | `/products/best_sellers/` | Hot/best-seller products |
| `GET` | `/products/new_arrivals/` | New arrival products |
| `GET` | `/products/by_category/?slug=phones` | Products filtered by category slug |
| `GET` | `/products/by_brand/?slug=samsung` | Products filtered by brand slug |
| `GET` | `/products/{slug}/reviews/` | Get reviews for product |
| `POST` | `/products/{slug}/reviews/` | Post a review (ðŸ”’) |

**Filter & search query params:**

```
/products/?search=samsung+a55
/products/?brand__slug=samsung&is_featured=true
/products/?ordering=-created_at
/products/?is_new=true&page=2
```

---

### Cart

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/cart/` | View current cart (session or user) |
| `POST` | `/cart/` | Add item to cart |
| `DELETE` | `/cart/{id}/` | Remove item from cart |
| `PATCH` | `/cart/update_item/` | Update item quantity |
| `DELETE` | `/cart/clear/` | Empty the cart |

**Add to cart request:**
```json
{
  "product_id": "uuid-here",
  "variant_id": 5,
  "quantity": 1
}
```

---

### Orders

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/orders/` | List user's orders (ðŸ”’) |
| `POST` | `/orders/` | Create order from current cart (ðŸ”’) |
| `GET` | `/orders/{id}/` | Order detail (ðŸ”’) |

**Create order request:**
```json
{
  "full_name": "John Kamau",
  "email": "john@example.com",
  "phone": "0712345678",
  "shipping_address": "123 Tom Mboya Street",
  "city": "Nairobi",
  "county": "Nairobi",
  "payment_method": "mpesa",
  "mpesa_phone": "0712345678",
  "notes": ""
}
```

Shipping fee is flat **KES 200**. Cart is cleared automatically after order creation.

---

### M-Pesa Payments

| Method | Endpoint | Description |
|---|---|---|
| `POST` | `/mpesa/stk-push/` | Initiate STK Push to customer's phone (ðŸ”’) |
| `POST` | `/mpesa/callback/` | Safaricom callback (public, called by Safaricom) |

**STK Push request:**
```json
{
  "order_id": "uuid-of-order",
  "phone": "0712345678"
}
```

**STK Push success response:**
```json
{
  "message": "STK push sent. Check your phone.",
  "checkout_request_id": "ws_CO_..."
}
```

Safaricom calls the callback URL automatically. On success, the order's `payment_status` is set to `paid` and `status` to `confirmed`.

---

### Wishlist

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/wishlist/` | Get wishlist (ðŸ”’) |
| `POST` | `/wishlist/` | Add product to wishlist (ðŸ”’) |
| `DELETE` | `/wishlist/{id}/` | Remove from wishlist (ðŸ”’) |

---

### Banners & Recently Viewed

| Method | Endpoint | Description |
|---|---|---|
| `GET` | `/banners/` | All active banners |
| `GET` | `/banners/hero/` | Hero slider banners only |
| `GET` | `/recently-viewed/` | Last 10 viewed products |

---

## M-Pesa Integration

### How the STK Push flow works

```
Frontend           Backend              Safaricom Daraja
   â”‚                  â”‚                       â”‚
   â”‚â”€â”€â”€ POST â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚
   â”‚  /mpesa/stk-push â”‚                       â”‚
   â”‚                  â”‚â”€â”€ GET OAuth token â”€â”€â”€â–ºâ”‚
   â”‚                  â”‚â—„â”€â”€ access_token â”€â”€â”€â”€â”€â”€â”‚
   â”‚                  â”‚                       â”‚
   â”‚                  â”‚â”€â”€ POST STK Push â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                  â”‚â—„â”€â”€ CheckoutRequestID â”€â”‚
   â”‚â—„â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
   â”‚  "Check phone"   â”‚                       â”‚
   â”‚                  â”‚        (async)        â”‚
   â”‚                  â”‚â—„â”€â”€ POST /callback/ â”€â”€â”€â”‚
   â”‚                  â”‚   (success or fail)   â”‚
   â”‚                  â”‚                       â”‚
   â”‚                  â”‚ Order updated to       â”‚
   â”‚                  â”‚ payment_status=paid   â”‚
```

### Local development with ngrok

```bash
# Start ngrok in a separate terminal
ngrok http 8000

# Copy the HTTPS URL and update .env
MPESA_CALLBACK_URL=https://xxxx.ngrok-free.app/api/v1/mpesa/callback/
```

> âš ï¸ The ngrok URL changes each session unless you have a paid plan. Update `.env` and restart Django each time.

### Verifying credentials in the Django shell

```bash
python manage.py shell
```

```python
from django.conf import settings
print("KEY:", settings.MPESA_CONSUMER_KEY[:8])
print("SECRET:", settings.MPESA_CONSUMER_SECRET[:8])
print("CALLBACK:", settings.MPESA_CALLBACK_URL)
```

---

## Running in Production

### 1. Switch to PostgreSQL

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('DB_NAME'),
        'USER': os.environ.get('DB_USER'),
        'PASSWORD': os.environ.get('DB_PASSWORD'),
        'HOST': os.environ.get('DB_HOST', 'localhost'),
        'PORT': os.environ.get('DB_PORT', '5432'),
    }
}
```

### 2. Update settings for production

```python
DEBUG = False
ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']
MPESA_BASE_URL = 'https://api.safaricom.co.ke'  # Live endpoint
```

### 3. Collect static files

```bash
python manage.py collectstatic
```

### 4. Run with gunicorn

```bash
pip install gunicorn
gunicorn backend.wsgi:application --bind 0.0.0.0:8000 --workers 3
```

---

## Troubleshooting

### M-Pesa returns empty body / 500 error

**Cause:** `.env` values not loaded â€” `MPESA_CONSUMER_KEY` is empty string.

**Fix:** Ensure `settings.py` starts with:
```python
from dotenv import load_dotenv
load_dotenv(BASE_DIR / '.env')
```

Then verify:
```bash
python manage.py shell -c "from django.conf import settings; print(settings.MPESA_CONSUMER_KEY[:8])"
```

---

### `JSONDecodeError` on M-Pesa OAuth call

Safaricom returned an empty or HTML response. Causes:

- Wrong `MPESA_CONSUMER_KEY` / `MPESA_CONSUMER_SECRET`
- Using production credentials against sandbox URL (or vice versa)
- Network blocked â€” test with `curl`:

```bash
curl -u "YOUR_KEY:YOUR_SECRET" \
  "https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials"
```

---

### Callback never received (order stays `pending`)

- ngrok URL has changed â€” update `.env` and restart Django
- Callback URL path mismatch â€” must be exactly `/api/v1/mpesa/callback/`
- Check Daraja portal logs under **Simulation > Lipa Na M-Pesa Online**

---

### `CORS` errors from frontend

Add your frontend's exact origin to `settings.py`:

```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",   # Vite dev server
    "https://yourdomain.com",  # Production frontend
]
```

---

### Images not serving in development

Ensure `urls.py` includes media file serving:

```python
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    # ... your routes
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

---

## License

MIT Â© Amazon Kenya